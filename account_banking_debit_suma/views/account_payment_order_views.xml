<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Account config setting SUMA options -->
    <record id="account_config_settings_suma_view" model="ir.ui.view">
        <field name="name">suma.account_config_settings.view.form</field>
        <field name="model">account.config.settings</field>
        <field name="inherit_id" ref="account.view_account_config_settings"/>
        <field name="arch" type="xml">
            <xpath expr="//separator[@name='analytic_account']" position="before">
                <group name="suma" string="Tax management. Alicante County Council (SUMA)">
                    <field name="entity_code"
                           placehoder="Code - County - Entity"
                           widget="selection"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Add banking debit SUMA fields to account payment order form -->
    <record id="account_payment_order_form_suma" model="ir.ui.view">
        <field name="name">account.payment.order.form.suma</field>
        <field name="model">account.payment.order</field>
        <field name="inherit_id" ref="account_payment_order.account_payment_order_form"/>
        <field name="arch" type="xml">
            <data>
                <!-- Add resume_suma and direct_debit buttons -->
                <xpath expr="//button[@name='generated2uploaded']" position="after">
                    <button name="print_direct_debit_file"
                            type="object"
                            states="generated"
                            string="Generate Direct Debit file"
                            class="oe_highlight"
                            attrs="{'invisible': ['|', ('payment_mode_name', '!=', 'SUMA'), ('state', '!=', 'generated')]}"/>
                    <button name="%(action_suma_resume_report)d"
                            type="action"
                            states="generated"
                            string="Print SUMA resume"
                            class="oe_highlight"
                            attrs="{'invisible': ['|', ('payment_mode_name', '!=', 'SUMA'), ('state', '!=', 'generated')]}"/>
                </xpath>

                <!-- Replace PDF wizard button with TXT-to-CSV wizard -->
                <xpath expr="//button[@name='action_done_cancel']" position="after">
                    <button name="%(account_banking_debit_suma.action_txt_to_csv_wizard)d"
                            type="action"
                            string="Upload Movements"/>
                </xpath>

                <!-- Lock date_prefered field -->
                <xpath expr="//field[@name='date_prefered']" position="attributes">
                    <attribute name="attrs"
                                add="{'readonly': [('payment_mode_name', '=', 'SUMA')]}"/>
                </xpath>

                <!-- Make date_scheduled non-required when SUMA -->
                <xpath expr="//field[@name='date_scheduled']" position="replace">
                    <field name="date_scheduled"
                            attrs="{'invisible': [('date_prefered', '!=', 'fixed')],
                                    'required': [('date_prefered', '=', 'fixed'),
                                                ('payment_mode_name', '!=', 'SUMA')]}"/>
                </xpath>

                <!-- Set description as required when SUMA -->
                <xpath expr="//field[@name='description']" position="attributes">
                    <attribute name="attrs"
                                add="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                </xpath>

                <!-- SUMA options -->
                <xpath expr="//group[@name='head']" position="after">
                    <group string="SUMA options"
                            name="suma"
                            col="2"
                            attrs="{'invisible': [('payment_mode_name', '!=', 'SUMA')]}">
                        <group name="suma-left">
                            <field name="payment_mode_name" invisible="1"/>
                            <field name="entity"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="entity_type_code"
                                    style="width: 50%;"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="error_mode"
                                    style="width: 50%;"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="charge_type"
                                    style="width: 50%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="charge_year"
                                    style="width: 50%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                        </group>
                        <group name="suma-right">
                            <field name="concept"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="charge_issuance"
                                    style="width: 50%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="periodicity"
                                    style="width: 50%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')]}"/>
                            <field name="initial_period"
                                    style="width: 10%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')],
                                            'invisible': [('periodicity', '=', 'A')]}"/>
                            <field name="final_period"
                                    style="width: 10%;"
                                    widget="selection"
                                    attrs="{'required': [('payment_mode_name', '=', 'SUMA')],
                                            'invisible': [('periodicity', '=', 'A')]}"/>
                        </group>
                    </group>
                </xpath>

                <!-- Add errors tab -->
                <xpath expr="//page[@name='bank-payment-lines']" position="after">
                    <page name="errors"
                            string="Errors"
                            attrs="{'invisible': ['|', ('payment_mode_name', '!=', 'SUMA'),
                                                ('error_mode', '!=', 'permissive')]}">
                        <field name="errors_found" nolabel="1"/>
                    </page>
                </xpath>
            </data>
        </field>
    </record>

</odoo>