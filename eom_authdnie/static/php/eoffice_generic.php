<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,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"/>
    <title>Sede Electrónica [CHANGE-ME] </title>
</head>
<body>
<?php

// Vars
$frontend_url = '[CHANGE-ME]';
$cipher_key = 'a%C*F-JaNdRgUkXqj8Ymx59IYhv0vHe2' [CHANGE-ME];
$authorized_organizations = array("DIRECCION GENERAL DE LA POLICIA", "FNMT-RCM", "ACCV");
$RootCA = "/etc/ssl/certs/sede_accepted_certs.pem";
$sslClientVerify = getenv('SSL_CLIENT_VERIFY');


// Forbiden if not success
if ($sslClientVerify != "SUCCESS") {
   echo '<div>';
   echo '<strong>Error en la verificación del certificado.</strong><br>';
   echo 'El resultado de la verificación es ' . $sslClientVerify . '.';
   echo '</div>';
   return 403;
 }

// Get client SSL data
$certData = isset($_SERVER['SSL_CLIENT_CERT']) ? $_SERVER['SSL_CLIENT_CERT'] : null;
if (! $certData) {
   echo '<div>';
   echo '<strong>Error de Autenticación</strong><br>';
   echo 'No se encontró un certificado SSL.';
   echo '</div>';
   return 403;
}

// Insert data in temporal file
$randomNumber = rand(1000,99999);
$dirName = "/tmp/client_ssl-" . $randomNumber;
mkdir($dirName);
$clientCertFileName = $dirName . "/" . "client_cert.pem";
file_put_contents($clientCertFileName, $certData);

// Parse cert
$parsedCert = openssl_x509_parse($certData, true);
$authority = isset($parsedCert['issuer']['O']) ? $parsedCert['issuer']['O'] : 'Unknown';
if (! in_array($authority, $authorized_organizations)) {
   echo '<div>';
   echo '<strong>Organización No Aceptada: </strong>' . $authority;
   echo '</div>';
   return 403;
}

// Create ID token
$serialNumber = isset($parsedCert['subject']['serialNumber']) ? $parsedCert['subject']['serialNumber'] : 'Unknown';
$parts = explode('-', $serialNumber);
if (count($parts) == 2) {
   $dni = $parts[1];
} else {
   $dni = $serialNumber;
}
$country = isset($parsedCert['subject']['C']) ? $parsedCert['subject']['C'] : 'Unknown';
$first_name = isset($parsedCert['subject']['GN']) ? $parsedCert['subject']['GN'] : 'Unknown';
$last_name = isset($parsedCert['subject']['SN']) ? $parsedCert['subject']['SN'] : 'Unknown';
$data_to_encrypt = $country.":".$dni.":".$last_name.":".$first_name.":".$authority.":";

// Encrypt
$method = "AES-128-CBC";
if (strlen($cipher_key) == 24) {
   $method = "AES-192-CBC";
} elseif (strlen($cipher_key) == 32) {
   $method = "AES-256-CBC";
}
$iv = openssl_random_pseudo_bytes(openssl_cipher_iv_length($method));
$encrypted_raw = openssl_encrypt($data_to_encrypt, $method, $cipher_key, $options=OPENSSL_RAW_DATA, $iv);
$identif_token = base64_encode($iv.$encrypted_raw);
$_SERVER["FRONTEND_URL"] = $frontend_url;
$_SERVER["IDENTIF_TOKEN"] = $identif_token;

// Get OCSP URL from authorityInfoAccess
$ocspUrl = null;
$ocspUrlFromCert = null;
if (isset($parsedCert['extensions']['authorityInfoAccess'])) {
   $authorityInfoAccess = $parsedCert['extensions']['authorityInfoAccess'];
   preg_match('/OCSP - URI:(.+)/', $authorityInfoAccess, $matches);
   if (isset($matches[1])) {
      $ocspUrl = trim($matches[1]);
      $ocspUrlFromCert = True;
   }
}

// Get OCSP URL based on organazitaion
if ( ! $ocspUrl) {
   $ocspUrlFromCert = False;
   if ($authority == "DIRECCION GENERAL DE LA POLICIA") {
      $ocspUrl = "http://ocsp.dnie.es/";
   } elseif ($authority == "FNMT-RCM") {
      $ocspUrl = "http://ocspusu.cert.fnmt.es/ocspusu/OcspResponder/";
   } elseif ($authority == "ACCV") {
      $ocspUrl = "http://ocsp.accv.es/";
   } else {
      echo '<div>';
      echo '<strong>Advertencia</strong>';
      echo '<p>No se ha encontrado la URL para OSCP<br/>';
      echo 'Usando la Organización ' . $authority . '.</p>';
      echo '<p>No se puede verificar la vigencia del certificado.</p>';
      echo '</div>';
      return 403;
   }
}

// Check revoked cert
shell_exec("openssl crl2pkcs7 -nocrl -certfile " . $RootCA .
           " | openssl pkcs7 -print_certs | grep -v '^subject=\|^issuer=' | sed '/^$/d' > " . $dirName . "/root_certificates");
shell_exec("cd " . $dirName . "; csplit -z -f root_certificate- root_certificates '/-----BEGIN CERTIFICATE-----/' '{*}'");
$rootCerts = $dirName . "/root_certificate-*";
foreach (glob($rootCerts) as $rootCert) {
   $certOrgName = trim(shell_exec("openssl x509 -in " . $rootCert . " -noout -subject -nameopt multiline,sname | grep -w 'O' | cut -d '=' -f2 "));
   if ($certOrgName == $authority) {
      $ocspResult = 'unknown';
      $ocspResultRaw = shell_exec("openssl ocsp -issuer " . $rootCert . " -cert " . $clientCertFileName . " -url " . $ocspUrl .
                                  " 2>/dev/null  | grep 'client_cert.pem' | cut -d ':' -f2 | tr -d ' '");
      if (trim($ocspResultRaw) == 'good') {
          $ocspResult = 'good';
          break;
      } elseif (trim($ocspResultRaw) == 'revoked') {
          $ocspResult = 'revoked';
      }
      $ocspResult = strtolower($ocspResult);
    }
}

// Show cert OSCP status
if ($ocspResult != 'good') {
   echo '<div><strong>Estado de Revocación:</strong> Certificado esta revocado o no se pudo verificar</div>';
   return 403;
}

// Delete temporal directory (not deleted if errors)
array_map('unlink', glob($dirName . "/*"));
rmdir($dirName);
?>

<!-- Redirect to sede -->
<div>
  <form id="hidden_form" method="post" action="<?php echo $_SERVER["FRONTEND_URL"]?>">
    <input type="hidden" name="identif_token" value="<?php echo $_SERVER["IDENTIF_TOKEN"]?>">
    <input type="submit" id="hidden_button" style="display:block;" value="Click">
  </form>
  <script>
    document.getElementById("hidden_button").style.display="none";
    document.getElementById("hidden_form").submit();
  </script>
</div>

</body>
</html>
